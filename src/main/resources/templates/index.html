<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="burger-drop">
    <meta property="og:description" content="burger-drop에서 맛있는 시간을 보내주세요.">
    <meta property="og:image" content="images/og_burger.png">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/btn-custom.css" rel="stylesheet">
    <script src="/js/notification.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <title>BurgerDrop | 홈</title>

</head>
<body>
<div class="category-bar d-flex flex-column justify-content-center"
     style="height: 100%; width: 60px; background-color: #FF4004;position: fixed;z-index: 999">
    <ul style="list-style: none;padding-left: 0">
        <li class="mb-5 text-center animate__animated animate__pulse animate__infinite infinite"><a type="button" onclick="getCategoryProduct('burger')"><img alt=""
                                                                                                  src="/images/burger.png"
                                                                                                  width="50px"
                                                                                                  height="50px"
                                                                                                  style="background-color: white; border-radius: 50%"></a>
        </li>
        <li class="mb-5 text-center animate__animated animate__pulse animate__infinite	infinite"><a type="button" onclick="getCategoryProduct('side')"><img alt=""
                                                                                                src="/images/fries.png"
                                                                                                width="50px"
                                                                                                height="50px" style="background-color: white; border-radius: 50%"
                                                                                                ></a>
        </li>
        <li class="mb-5 text-center animate__animated animate__pulse animate__infinite	infinite"><a type="button" onclick="getCategoryProduct('drink')"><img alt=""
                                                                                                 src="/images/drink.png"
                                                                                                 width="50px"
                                                                                                 height="50px" style="background-color: white; border-radius: 50%"
                                                                                                 ></a>
        </li>
        <li class="mb-5 text-center animate__animated animate__pulse animate__infinite	infinite"><a type="button" onclick="getCategoryProduct('dessert')"><img alt=""
                                                                                                   src="/images/dessert.png"
                                                                                                   width="50px"
                                                                                                   height="50px" style="background-color: white; border-radius: 50%"
                                                                                                   ></a>
        </li>
        <li class="mb-5 text-center animate__animated animate__pulse animate__infinite	infinite"><a type="button" onclick="getCategoryProduct('likes')"><img alt=""
                                                                                                 src="/images/likes.png"
                                                                                                 width="50px"
                                                                                                 height="50px" style="background-color: white; border-radius: 50%"
                                                                                                 ></a>
        </li>
    </ul>
</div>
<!-- 네비게이션 바 start -->
<nav class="navbar mb-5" style="background-color: #ff921d">
    <div class="container-fluid d-flex mx-3">
        <a class="navbar-brand" href="/">
            <div class="ms-5 fs-4 fw-bold animate__animated animate__zoomIn">BurgerDrop</div>
        </a>
        <div class="" id="welcome">
            <span id="userRole" th:text="${userRole}"></span>
            <span class="fw-bold" id="username" th:text="${username}"></span>
            <span id="userAddress" th:text="${userAddress}"></span>
        </div>
        <div class="d-flex justify-content-end">
            <a href="/mypage">
                <button type="submit" class="btn btn-dark btn_custom ms-2" id="myPage-btn">My page</button>
            </a>
            <a href="/login">
                <button type="submit" class="btn btn-dark btn_custom ms-2" id="login-btn">Login</button>
            </a>
            <button type="button" onclick="logout()" class="btn btn-dark btn_custom ms-2" id="logout-btn">Logout</button>
            <a href="/signup">
                <button type="submit" class="btn btn-dark btn_custom ms-2" id="signup-btn">SignUp</button>
            </a>
            <a href="/cart">
                <button type="submit" class="btn btn-dark btn_custom ms-2" id="cart-btn">장바구니</button>
            </a>
            <button class="btn btn_custom btn-dark ms-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">알림</button>
            <a href="/admin">
                <button type="submit" class="btn btn-warning btn_custom ms-2" id="admin-btn">Admin</button>
            </a>
            <a href="/chatList">
                <button type="submit" class="btn btn-warning btn_custom ms-2" id="chat-btn">chatList</button>
            </a>
            <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
                <div class="offcanvas-header">
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body" id="notification-btn">
                    <ul id="notification-list">
                    </ul>
                    <button id="delete-all-btn" class="btn btn-danger" onclick="deleteAllNotifications()">알림 전체 삭제</button>
                </div>
            </div>
        </div>
    </div>
</nav>
<div class="container mb-5">
    <div class="d-flex align-items-center">

        <input id="keyword" class="form-control w-25 d-inline me-2" type="text" placeholder="검색어를 입력해주세요">
        <button class="btn btn-dark btn_custom" onclick="searchProduct()"><i class="fas fa-search"></i></button>
    </div>
    <div class="col row" id="search-productlist">
        <!-- 검색 결과 목록 동적 생성 -->
    </div>
    <hr class="border border-3">
</div>
<div class="container mb-5">
    <div class="col row" id="product-list">
        <!-- 상품 목록 동적 생성 -->
    </div>
</div>
<div class="inquiry-icon" id="chat-icon">
    <img src="https://cdn-icons-png.flaticon.com/128/2840/2840215.png" alt="Chat Icon" width="80" height="80">
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
<script>
    $(document).ready(function () {
        $('#chat-icon').off('click').on('click', function () {
            const token = Cookies.get('Authorization');

            if (!token) {
                alert('로그인이 필요한 서비스 입니다.');
                window.location.href="/login";
                return;
            }

            const payloads = JSON.parse(atob(token.split(".")[1]));
            const username = payloads.sub;
            let roomId;

            // 채팅 룸 생성 요청을 보냅니다.
            $.ajax({
                url: '/api/chat/createAndEnterChatRoom',
                method: 'POST',
                dataType: 'json',
                success: function (response) {
                    roomId = response.roomId;
                    var chatUrl = '/chatting?roomId=' + roomId;
                    window.location.href = chatUrl;
                },
                error: function (xhr, status, error) {
                    alert("채팅 룸 생성 실패");
                    console.log(xhr);
                }
            });
        });
    });

    window.onload = function () {
        var login_btn = document.getElementById("login-btn");
        var signup_btn = document.getElementById("signup-btn");
        var logout_btn = document.getElementById("logout-btn");
        var mypage_btn = document.getElementById("myPage-btn");
        var welcome = document.getElementById("welcome");
        var cart_btn = document.getElementById("cart-btn");
        var admin_btn = document.getElementById("admin-btn");
        var userRole = document.getElementById("userRole")
        var chatList = document.getElementById("chat-btn");
        var chatRoom = document.getElementById("chat-icon");
        var notification = document.getElementById("notification-btn");

        // "Authorization" 쿠키가 존재하는 경우 로그인 상태
        if (checkAuthorizationCookie()) {
            logout_btn.style.display = "block";
            mypage_btn.style.display = "block";
            chatRoom.style.display = "block";
            welcome.style.display = "block";
            cart_btn.style.display = "block";

            if (userRole.innerText === "ADMIN") {
                admin_btn.style.display = "block";
                chatList.style.display = "block";
                chatRoom.style.display = "none";
                notification.style.display = "none";
            } else {
                admin_btn.style.display = "none";
                chatList.style.display = "none";
                chatRoom.style.display = "block";
                notification.style.display = "block";
            }

            login_btn.style.display = "none";
            signup_btn.style.display = "none";
        } else { // 로그인 상태가 아닌 경우
            logout_btn.style.display = "none";
            mypage_btn.style.display = "none";
            welcome.style.display = "none";
            cart_btn.style.display = "none";
            admin_btn.style.display = "none";
            chatList.style.display = "none";
            notification.style.display = "none";

            login_btn.style.display = "block";
            signup_btn.style.display = "block";
        }
    }

    $(document).ready(function () {
        var userAddress = $("#userAddress").text();

        // 예시: userAddress가 '주소없음'인 경우 처리
        if (userAddress === '주소없음') {
            alert("이런! 주소가 등록이 안되어있군요. 주소를 등록해주세요")
            window.location.href ='/user/address';
        }

        getProduct();
    });

    function logout() {
        //리프레시 토큰 삭제 요청

        fetch('/api/user/logout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(response => response.json())
            .then(data => {
                alert(data.msg)
                // 쿠키 삭제
                document.cookie = "Authorization=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                window.location.href = "/"
            });


    }

    function getProduct() {
        fetch('/api/products', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(data => {
                $('#product-list').empty()
                for (let i = 0; i < data.length; i++) {
                    let productName = data[i].productName;
                    let productPrice = data[i].productPrice;
                    let category = data[i].category;
                    let createdAt_temp = data[i].createdAt; // 2023-09-07T21:02:48.852452
                    let dateObject = new Date(createdAt_temp);

                    let year = dateObject.getFullYear();
                    let month = String(dateObject.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1, 2자리 숫자로 패딩
                    let day = String(dateObject.getDate()).padStart(2, '0'); // 일, 2자리 숫자로 패딩

                    let createdAt = `${year}-${month}-${day}`;


                    let productImage;
                    if (data[i].productImage === '' || data[i].productImage == null) {
                        productImage = "/images/img.png"
                    } else {
                        productImage = data[i].productImage;
                    }

                    let productId = data[i].id;
                    let productScore = data[i].productScore;
                    console.log(productScore)

                    let scoreStar;
                    if (productScore === 1) {
                        scoreStar = "⭐"
                    } else if (productScore === 2) {
                        scoreStar = "⭐⭐"
                    } else if (productScore === 3) {
                        scoreStar = "⭐⭐⭐"
                    } else if (productScore === 4) {
                        scoreStar = "⭐⭐⭐⭐"
                    } else if (productScore === 5) {
                        scoreStar = "⭐⭐⭐⭐⭐"
                    }else {
                        scoreStar = ""
                    }

                    let temp_html = `<a href = product/${productId} class= "col-3">
                                         <div class= "col" style="margin-top: 30px">
                                            <div class="card h-100 feed border-0">
                                                <img src="${productImage}" class="card-img-top" alt="sampleImage" style="height: 250px;">
                                                <div class="card-body">
                                                    <h5 class="card-title fw-bold">${productName}</h5>
                                                    <p class="card-text text-truncate">${productPrice}원</p>
                                                    <p class="card-text text-muted">${createdAt}</p>
                                                    <p class="card-text text-muted">평점 : ${scoreStar}</p>
                                                </div>
                                            </div>
                                        </div>
                                     </a>`
                    $('#product-list').append(temp_html)
                }
            })
    }

    function searchProduct() {
        let data2 = {
            keyword: document.getElementById("keyword").value
        }

        fetch('/api/product', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data2)
        })
            .then(response => response.json())
            .then(data => {
                $('#product-list').empty()
                $('#search-productlist').empty()
                for (let i = 0; i < data.length; i++) {
                    let productName = data[i].productName;
                    let productPrice = data[i].productPrice;
                    let createdAt_temp = data[i].createdAt; // 2023-09-07T21:02:48.852452
                    let dateObject = new Date(createdAt_temp);

                    let year = dateObject.getFullYear();
                    let month = String(dateObject.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1, 2자리 숫자로 패딩
                    let day = String(dateObject.getDate()).padStart(2, '0'); // 일, 2자리 숫자로 패딩

                    let createdAt = `${year}-${month}-${day}`;

                    let productImage;
                    if (data[i].productImage === '' || data[i].productImage == null) {
                        productImage = "/images/img.png"
                    } else {
                        productImage = data[i].productImage;
                        console.log(productImage)
                    }

                    let productId = data[i].id;
                    let productScore = data[i].productScore;

                    let scoreStar;
                    if (productScore === 1) {
                        scoreStar = "⭐"
                    } else if (productScore === 2) {
                        scoreStar = "⭐⭐"
                    } else if (productScore === 3) {
                        scoreStar = "⭐⭐⭐"
                    } else if (productScore === 4) {
                        scoreStar = "⭐⭐⭐⭐"
                    } else if (productScore === 5) {
                        scoreStar = "⭐⭐⭐⭐⭐"
                    }else {
                        scoreStar = ""
                    }

                    let temp_html = `<a href = product/${productId} class= "col-3">
                                         <div class= "col" style="margin-top: 30px">
                                            <div class="card h-100 feed border-0">
                                                <img src="${productImage}" class="card-img-top" alt="sampleImage" style="height: 250px;">
                                                <div class="card-body">
                                                    <h5 class="card-title fw-bold">${productName}</h5>
                                                    <p class="card-text text-truncate">${productPrice}원</p>
                                                    <p class="card-text text-muted">${createdAt}</p>
                                                    <p class="card-text text-muted">평점 : ${scoreStar}</p>
                                                </div>
                                            </div>
                                        </div>
                                     </a>`
                    $('#search-productlist').append(temp_html)
                }
            })
    }

    function getCategoryProduct(category) {
        if(category !== 'likes'){
            fetch('/api/products/' + category, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => response.json())
                .then(data => {
                    $('#search-productlist').empty()
                    $('#product-list').empty()
                    for (let i = 0; i < data.length; i++) {
                        let productName = data[i].productName;
                        let productPrice = data[i].productPrice;
                        let createdAt_temp = data[i].createdAt; // 2023-09-07T21:02:48.852452
                        let dateObject = new Date(createdAt_temp);

                        let year = dateObject.getFullYear();
                        let month = String(dateObject.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1, 2자리 숫자로 패딩
                        let day = String(dateObject.getDate()).padStart(2, '0'); // 일, 2자리 숫자로 패딩

                        let createdAt = `${year}-${month}-${day}`;

                        let productImage;
                        if (data[i].productImage === '' || data[i].productImage == null) {
                            productImage = "/images/img.png"
                        } else {
                            productImage = data[i].productImage;
                        }

                        let productId = data[i].id;
                        let productScore = data[i].productScore;

                        let scoreStar;
                        if (productScore === 1) {
                            scoreStar = "⭐"
                        } else if (productScore === 2) {
                            scoreStar = "⭐⭐"
                        } else if (productScore === 3) {
                            scoreStar = "⭐⭐⭐"
                        } else if (productScore === 4) {
                            scoreStar = "⭐⭐⭐⭐"
                        } else if (productScore === 5) {
                            scoreStar = "⭐⭐⭐⭐⭐"
                        }else {
                            scoreStar = ""
                        }

                        let temp_html = `<a href = product/${productId} class= "col-3">
                                         <div class= "col" style="margin-top: 30px">
                                            <div class="card h-100 feed border-0">
                                                <img src="${productImage}" class="card-img-top" alt="sampleImage" style="height: 250px;">
                                                <div class="card-body">
                                                    <h5 class="card-title fw-bold">${productName}</h5>
                                                    <p class="card-text text-truncate">${productPrice}원</p>
                                                    <p class="card-text text-muted">${createdAt}</p>
                                                    <p class="card-text text-muted">평점 : ${scoreStar}</p>
                                                </div>
                                            </div>
                                        </div>
                                     </a>`
                        $('#product-list').append(temp_html)
                    }
                })
        }else {
            //리뷰 목록 조회
            fetch('/api/comments', {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => response.json())
                .then(data => {
                    $('#search-productlist').empty()
                    $('#product-list').empty()

                    console.log(data)
                    let reviewList = data;
                    console.log(reviewList)
                    for (let i=data.length-1; i>=0; i--){
                        let content = reviewList[i].content;
                        let nickname = reviewList[i].nickname;
                        let productImage = reviewList[i].commentProductImage;
                        let productName = reviewList[i].commentProductName;
                        let productScore = reviewList[i].commentProductScore;
                        console.log(productScore)

                        let scoreStar;
                        if (productScore === 1) {
                            scoreStar = "⭐"
                        } else if (productScore === 2) {
                            scoreStar = "⭐⭐"
                        } else if (productScore === 3) {
                            scoreStar = "⭐⭐⭐"
                        } else if (productScore === 4) {
                            scoreStar = "⭐⭐⭐⭐"
                        } else if (productScore === 5) {
                            scoreStar = "⭐⭐⭐⭐⭐"
                        }else {
                            scoreStar = ""
                        }

                        console.log(scoreStar)

                        let temp_html = `
                                <div class="col-md-6 mt-3">
                                  <div class="border rounded" style="background-color: rgb(248,246,246)">
                                  <div class="review-box d-flex flex-row mt-3 ms-3">
                                    <img src="${productImage}" class="border rounded-circle me-2" alt="" width="45px" height="45px">
                                    <div class="review-info d-flex flex-column w-100">
                                    <div class="d-flex flex-row justify-content-between">
                                            <p class="mb-0 ms-1">${productName}</p>
                                            <p class="mb-0 me-3">${nickname}</p>
                                     </div>
                                      <p class="">${scoreStar}</p>
                                     </div>
                                  </div>
                                  <p class="review-msg ms-4">${content}</p>
                                  </div>
                                </div>`
                        $('#product-list').append(temp_html)
                    }
                });
        }

    }

</script>
</body>
</html>
