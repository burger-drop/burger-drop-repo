<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notification Test Page</title>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        let eventSource = null;

        function createES() {
            const eventSource = new EventSource(`/subscribe`);

            eventSource.addEventListener("sse", function (event) {

                console.log(event);

                console.log(event.data);
                const rawData = JSON.parse(event.data);
                const ntId = rawData.id;
                const content = rawData.content;
                const nt = rawData.notificationType;
                const title = rawData.title;
                console.log(content + nt + title);

                (async () => {

                    if (Notification.permission === "granted") {
                        showNotification2(content, nt, title, ntId);
                        //showNotification();
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then(function (permission) {
                            if (permission === "granted") {
                                showNotification2(content, nt, title, ntId);
                                //showNotification();
                            }
                        });
                    }
                })();
            });
        }

        function closeEventSource() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        function showNotification2(content, notificationType, title, ntId) {
            const notificationOptions = {
                body: notificationType + ": " + content,
                icon: "path/to/icon.png" // 사용자에게 보일 아이콘의 경로
            };

            const notification = new Notification(title, notificationOptions);

            notification.onclick = function () {
                // 알림 클릭 시 수행할 동작 설정
                window.open("http://localhost:8080/api/users/user-login");
                notification.close();

            };

            notification.onshow = function () {
                console.log("isRead true 로 변경");
                $.ajax({
                    url: `/api/notification/${ntId}`, // 요청을 보낼 서버의 URL
                    method: 'PATCH', // 요청 메소드 (GET, POST 등)
                    contentType: "application/json",
                    success: function (response) {
                        console.log("읽기 처리 완료");
                    },
                    error: function (xhr, status, error) {
                        console.log("읽기 처리 실패");
                    }
                });
            }
        }

        function showNotification() {
            const notificationOptions = {
                body: "example",
                icon: "path/to/icon.png" // 사용자에게 보일 아이콘의 경로
            };

            const notification = new Notification("로그인 알림", notificationOptions);

            notification.onclick = function () {
                // 알림 클릭 시 수행할 동작 설정
                window.open("http://localhost:8080/api/users/user-login");
                notification.close();
                //isRead true 로 변경
            };

        }

        window.onload = createES();

        window.onbeforeunload = closeEventSource();

    </script>
</head>

<body>
<h1>로그인 된 상태의 어느 페이지</h1>
</body>
</html>